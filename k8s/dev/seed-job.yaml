apiVersion: v1
kind: ConfigMap
metadata:
  name: seed-data-script
  namespace: suneasy-dev
data:
  seed-data.sql: |
    -- This will be replaced by mounting the actual script
    -- Or you can embed the script here directly
---
apiVersion: batch/v1
kind: Job
metadata:
  name: seed-data-job
  namespace: suneasy-dev
  labels:
    app: seed-data
spec:
  # Allow manual re-runs by changing this
  backoffLimit: 3
  ttlSecondsAfterFinished: 3600  # Keep job for 1 hour after completion
  template:
    metadata:
      labels:
        app: seed-data
    spec:
      restartPolicy: OnFailure

      # Init container to wait for PostgreSQL to be ready
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready -h postgres-service -p 5432 -U postgres; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          echo "PostgreSQL is up - checking databases..."

          # Wait for databases to exist
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            databases=$(PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres-service -U postgres -lqt | cut -d \| -f 1 | grep -w suneasy_auth | wc -l)
            if [ "$databases" -ge 1 ]; then
              echo "Databases are ready!"
              exit 0
            fi
            echo "Waiting for databases to be created... (attempt $attempt/$max_attempts)"
            sleep 3
            attempt=$((attempt + 1))
          done

          echo "WARNING: Databases not found after $max_attempts attempts, proceeding anyway..."
          exit 0
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: PGCONNECT_TIMEOUT
          value: "10"

      containers:
      - name: seed-data
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          set -e
          echo "=========================================="
          echo "SunEasy Seed Data Job"
          echo "=========================================="
          echo "Starting seed data import..."
          echo ""

          # Check if seed script exists
          if [ ! -f /scripts/seed-comprehensive-data.sql ]; then
            echo "ERROR: Seed script not found at /scripts/seed-comprehensive-data.sql"
            exit 1
          fi

          echo "Seed script found. File size: $(wc -l < /scripts/seed-comprehensive-data.sql) lines"
          echo ""

          # Run the seed script
          echo "Executing seed script..."
          PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres-service -U postgres -f /scripts/seed-comprehensive-data.sql

          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "=========================================="
            echo "SUCCESS: Seed data imported successfully!"
            echo "=========================================="
            echo ""
            echo "Test Credentials:"
            echo "  Admin (Sunset Paradise): admin@sunsetparadise.com / password123"
            echo "  Manager: manager1@sunsetparadise.com / password123"
            echo "  Customer: john.smith@email.com / password123"
            echo ""
            echo "Total users created: 50+"
            echo "Total organizations: 5"
            echo ""
          else
            echo ""
            echo "=========================================="
            echo "ERROR: Seed data import failed!"
            echo "Exit code: $exit_code"
            echo "=========================================="
            exit $exit_code
          fi
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: PGHOST
          value: postgres-service
        - name: PGUSER
          value: postgres
        volumeMounts:
        - name: seed-script
          mountPath: /scripts
          readOnly: true

      volumes:
      - name: seed-script
        hostPath:
          path: /root/projects/suneasy/SunEasyBE/Scripts
          type: Directory
